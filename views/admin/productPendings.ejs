<link rel="stylesheet" href="../../styles/admin/productPendings.css">

<!-- Page Header -->
<div class="page-header">
    <h1 class="page-title">Pending Products List</h1>
</div>

<!-- Breadcrumb -->
<div class="breadcrumb">
    <a href="/admin/dashboard">Dashboard</a>
    <span class="breadcrumb-separator">></span>
    <a href="/admin/products">Products</a>
    <span class="breadcrumb-separator">></span>
    <span>Product Pendings</span>
</div>

<!-- Pending Products Table -->
<div class="pending-products-table">
    <table>
        <thead class="table-header">
            <tr>
                <th>Image</th>
                <th>Product Name</th>
                <th>Brand Name</th>
                <th>Category</th>
                <th>Price</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            <% if (products && products.length> 0) { %>
                <% products.forEach(product=> { %>
                    <tr class="table-row" id="product-row-<%= product._id %>">
                        <td>
                            <img src="<%= product.variants && product.variants[0] && product.variants[0].images && product.variants[0].images[0] ? product.variants[0].images[0].url : '/default-image.jpg' %>"
                                alt="<%= product.name || 'Product image' %>" class="product-image">
                        </td>
                        <td>
                            <div class="product-info">
                                <span class="product-name">
                                    <%= product.name %>
                                </span>
                            </div>
                        </td>
                        <td class="brand-name">
                            <%= product.vendorId?.brandName || 'Unknown Vendor' %>
                        </td>
                        <td>
                            <span class="product-category">
                                <%= product.category?.name || 'Unknown' %>
                            </span>
                        </td>
                        <td class="product-price">
                            â‚¹<%= (product.price || 0).toFixed(2) %>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-approve" data-product-id="<%= product._id %>">Approve</button>
                                <button class="btn btn-cancel" data-product-id="<%= product._id %>">Reject</button>
                            </div>
                        </td>
                    </tr>
                    <% }) %>
                        <% } else { %>
                            <tr>
                                <td colspan="6">
                                    <div class="empty-state">
                                        <i class="fas fa-box-open"></i>
                                        <h3>No Pending Products</h3>
                                        <p>All product applications have been processed.</p>
                                    </div>
                                </td>
                            </tr>
                            <% } %>
        </tbody>
    </table>
</div>

<!-- Pagination -->
<div class="pagination">
    <div class="pagination-info">
        Showing 1-<%= products.length %> of <%= totalProducts %> products
    </div>
    <div class="pagination-controls">
        <button class="pagination-btn" <%=currentPage==1 ? 'disabled' : '' %> onclick="changePage(<%= currentPage - 1 %>
                )" aria-label="Previous page">
                <i class="fas fa-chevron-left" aria-hidden="true"></i>
        </button>
        <% for (let i=1; i <=totalPages; i++) { %>
            <button class="pagination-btn <%= i === currentPage ? 'active' : '' %>" onclick="changePage(<%= i %>)"
                aria-label="Page <%= i %>">
                <%= i %>
            </button>
            <% } %>
                <button class="pagination-btn" <%=currentPage==totalPages ? 'disabled' : '' %> onclick="changePage(<%=
                        currentPage + 1 %>)" aria-label="Next page">
                        <i class="fas fa-chevron-right" aria-hidden="true"></i>
                </button>
    </div>
</div>

<script>
    function changePage(page) {
        const url = new URL(window.location);
        url.searchParams.set('page', page);
        window.location.href = url.href;
    }

    // Attach event listeners after DOM load
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".btn-approve").forEach((button) => {
            button.addEventListener("click", () => {
                const productId = button.getAttribute("data-product-id");
                approveProduct(productId, button);
            });
        });

        document.querySelectorAll(".btn-cancel").forEach((button) => {
            button.addEventListener("click", () => {
                const productId = button.getAttribute("data-product-id");
                rejectProduct(productId, button);
            });
        });
    });

    // Approve Product
    async function approveProduct(productId, button) {
        const originalText = button.textContent;

        const result = await Swal.fire({
            title: "Approve Product?",
            text: "Do you want to approve this product?",
            icon: "question",
            showCancelButton: true,
            confirmButtonColor: "#28a745",
            cancelButtonColor: "#6c757d",
            confirmButtonText: "Yes, approve",
        });

        if (!result.isConfirmed) return;

        button.disabled = true;
        button.textContent = "Approving...";

        try {
            const response = await axios.patch("/admin/products/pendings/approve", { productId });

            await Swal.fire({
                icon: "success",
                title: "Approved!",
                text: response.data.message,
                timer: 1500,
                showConfirmButton: false,
                customClass: {
                    confirmButton: "swal-confirm-black",
                },
            });

            removeProductRow(productId);
        } catch (error) {
            console.error("Error approving product:", error);

            Swal.fire({
                icon: "error",
                title: "Oops...",
                text:error.response?.data?.message || "Failed to approve product. Please try again.",
                customClass: {
                    confirmButton: "swal-confirm-black",
                },
            });

            button.disabled = false;
            button.textContent = originalText;
        }
    }

    // Reject Product
    async function rejectProduct(productId, button) {
        const originalText = button.textContent;

        const result = await Swal.fire({
            title: "Reject Product?",
            text: "This product application will be rejected.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#3085d6",
            confirmButtonText: "Yes, reject it",
        });

        if (!result.isConfirmed) return;

        button.disabled = true;
        button.textContent = "Rejecting...";

        try {
            const response = await axios.patch("/admin/products/pendings/reject", { productId });

            await Swal.fire({
                icon: "success",
                title: "Rejected!",
                text: response.data.message,
                timer: 1500,
                showConfirmButton: false,
                customClass: {
                    confirmButton: "swal-confirm-black",
                },
            });

            removeProductRow(productId);
        } catch (error) {
            console.error("Error rejecting product:", error);

            Swal.fire({
                icon: "error",
                title: "Oops...",
                text:error.response?.data?.message ||"Failed to reject product. Please try again.",
                customClass: {
                    confirmButton: "swal-confirm-black",
                },
            });

            button.disabled = false;
            button.textContent = originalText;
        }
    }

    // Remove row with animation & check empty state
    function removeProductRow(productId) {
        const row = document.getElementById(`product-row-${productId}`);
        if (row) {
            row.style.transition = "opacity 0.3s ease";
            row.style.opacity = "0";
            setTimeout(() => {
                row.remove();
                checkEmptyState();
            }, 300);
        }
    }

    // Show empty state if no rows remain
    function checkEmptyState() {
        const tableBody = document.querySelector(".pending-products-table tbody");
        if (!tableBody.querySelector(".table-row")) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7">
                        <div class="empty-state">
                            <i class="fas fa-box-open"></i>
                            <h3>No Pending Products</h3>
                            <p>All product applications have been processed.</p>
                        </div>
                    </td>
                </tr>
            `;
        }
    }
</script>