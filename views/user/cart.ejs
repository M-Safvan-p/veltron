<link rel="stylesheet" href="../../styles/user/cart.css">
<div class="container">
    <div class="cart-header">
        <h1 class="cart-title">CART</h1>
        <% if (cart && cart.items && cart.items.length> 0) { %>
            <button class="empty-cart-btn" onclick="emptyCart()">Empty my Cart</button>
            <% } %>
    </div>

    <% if (!cart || !cart.items || cart.items.length===0) { %>
        <div class="empty-cart">
            <h2>Your cart is empty</h2>
            <p>Add some products to get started!</p>
            <a href="/sale" class="checkout-btn continue-shopping"
                style="display: inline-block; text-decoration: none; width: auto; padding: 15px 30px;">
                Continue Shopping
            </a>
        </div>
        <% } else { %>
            <% cart.items.forEach(function(item, index) { %>
                <div class="cart-item">
                    <img src="<%= item.image %>" alt="<%= item.productName %>" class="product-image">

                    <div class="product-details">
                        <a href="/product/<%= item.productId.toString() %>">
                            <h3 class="product-name">
                                <%= item.productName %>
                            </h3>
                        </a>
                        <div class="product-price">
                            <span class="original-price">₹<%= item.price.toLocaleString() %></span>
                            <span class="discounted-price">₹<%= item.discountedPrice.toLocaleString() %></span>
                        </div>
                        <% if (item.selectedColor) { %>
                            <div class="product-color">Colour: <%= item.selectedColor %>
                            </div>
                            <% } %>
                                <% if (item.price> item.discountedPrice) { %>
                                    <div class="savings">Save ₹<%= (item.price - item.discountedPrice).toLocaleString()
                                            %>
                                    </div>
                                    <% } %>
                    </div>

                    <div class="quantity-controls">
                        <button class="quantity-btn minus" onclick="decreaseQuantity('<%= item.variantId %>')"
                            <%=item.quantity <=1 ? 'disabled' : '' %>>−</button>
                        <span class="quantity-display">
                            <%= item.quantity %>
                        </span>
                        <button class="quantity-btn plus" onclick="increaseQuantity('<%= item.variantId %>')"
                            <%=item.quantity>= 5 ? 'disabled' : '' %>>
                            +
                        </button>
                    </div>

                    <button class="remove-btn" onclick="removeItem('<%= item._id %>')">Remove</button>
                </div>
                <% }); %>

                    <div class="cart-summary">
                        <div class="subtotal">
                            <span>SUBTOTAL</span>
                            <span>
                                <% let originalTotal=0; let discountedTotal=0; cart.items.forEach(function(item) {
                                    originalTotal +=item.price * item.quantity; discountedTotal +=item.discountedPrice *
                                    item.quantity; }); %>
                                    <span class="original-price">INR <%= originalTotal.toLocaleString() %></span>
                                    <span class="discounted-price" style="margin-left: 10px;">INR <%=
                                            discountedTotal.toLocaleString() %></span>
                            </span>
                        </div>

                        <p class="shipping-note">Shipping, taxes, and discount codes calculated at checkout.</p>

                        <div class="checkout-buttons">
                            <button class="checkout-btn proceed-checkout" onclick="proceedToCheckout()">Proceed to
                                checkout</button>
                            <a href="/sale" style="text-decoration: none;">
                                <button type="button" class="checkout-btn continue-shopping">Continue Shopping</button>
                            </a>
                        </div>
                    </div>
                    <% } %>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    async function removeItem(itemId) {
        try {
            await axios.post(`/cart/remove/${itemId}`);
            window.location.reload();
        } catch (error) {
            console.error('Error removing item:', error);
            Swal.fire({
                icon: "error",
                title: "Oops!",
                text: "Failed to remove item from cart.",
            });
        }
    }

    async function increaseQuantity(itemId) {
        try {
            await axios.post(`/cart/increase/${itemId}`);
            window.location.reload();
        } catch (error) {
            console.error('Error increasing quantity:', error);
            Swal.fire({
                icon: 'error',
                title: 'Oops!',
                text: 'Failed to increase quantity.'
            });
        }
    }

    async function decreaseQuantity(itemId) {
        try {
            await axios.post(`/cart/decrease/${itemId}`);
            window.location.reload();
        } catch (error) {
            console.error('Error decreasing quantity:', error);
            Swal.fire({
                icon: 'error',
                title: 'Oops!',
                text: 'Failed to decrease quantity.'
            });
        }
    }

    async function emptyCart() {
        const result = await Swal.fire({
            title: 'Are you sure?',
            text: "This action cannot be undone!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, empty cart!',
            cancelButtonText: 'Cancel'
        });
        if (!result.isConfirmed) return;

        try {
            await axios.post('/cart/empty');
            window.location.reload();
        } catch (error) {
            console.error('Error emptying cart:', error);

            Swal.fire({
                title: 'Error!',
                text: 'Failed to empty cart.',
                icon: 'error',
                confirmButtonText: 'OK'
            });
        }
    }

    async function proceedToCheckout() {
        try {
            await axios.get('/checkout');
            window.location.href = '/checkout';
        } catch (error) {
            console.error('Error proceeding to checkout:', error);
            alert('Failed to proceed to checkout.');
        }
    }
</script>