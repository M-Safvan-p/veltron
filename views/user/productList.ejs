<!-- Enhanced Watch Product Listing Page -->
<link rel="stylesheet" href="/styles/user/productList.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<!-- Hero Banner -->
<section class="hero">
    <div class="container">
        <div class="hero-content">
            <div class="hero-text">
                <h1 class="hero-title">Premium Watch Collection</h1>
                <p class="hero-subtitle">Discover timeless elegance with our curated selection</p>
                <a href="/sale" class="hero-btn" aria-label="Shop watches now">Shop Now</a>
            </div>
        </div>
    </div>
</section>

<!-- Main Content -->
<main class="main">
    <div class="container">
        <div class="content-wrapper">
            <form action="/sale" method="GET" id="filterForm" role="search" aria-label="Product filters">
                <div class="filter-products-wrapper">
                    <!-- Mobile Filter Toggle -->
                    <button type="button" class="mobile-filter-toggle" aria-expanded="false" aria-controls="sidebar">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" aria-hidden="true">
                            <polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46"></polygon>
                        </svg>
                        Filters
                    </button>

                    <!-- Sidebar Filters -->
                    <aside class="sidebar" id="sidebar" role="complementary" aria-label="Product filters">
                        <div class="sidebar-header">
                            <h2 class="sidebar-title">Filters</h2>
                            <button type="button" class="close-filters" aria-label="Close filters">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" aria-hidden="true">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>

                        <!-- Categories Filter -->
                        <div class="filter-section">
                            <h3 class="filter-title">Categories</h3>
                            <ul class="filter-list" role="group" aria-label="Category filters">
                                <% if (categories && categories.length > 0) { %>
                                    <% categories.forEach(function(cat) { %>
                                        <li>
                                            <label class="filter-label">
                                                <input type="checkbox" name="category" value="<%= cat._id %>"
                                                    <%= (query.category ? (Array.isArray(query.category) ? query.category : [query.category]).includes(cat._id.toString()) : false) ? 'checked' : '' %>
                                                    onchange="this.form.submit()" class="filter-checkbox">
                                                <span class="checkmark"></span>
                                                <%= cat.name || 'Uncategorized' %>
                                            </label>
                                        </li>
                                    <% }); %>
                                <% } else { %>
                                    <li class="no-options">No categories available</li>
                                <% } %>
                            </ul>
                        </div>

                        <!-- Price Range Filter -->
                        <div class="filter-section">
                            <h3 class="filter-title">Price Range</h3>
                            <div class="price-range">
                                <div class="price-options">
                                    <label>
                                        <input type="radio" name="priceRange" value="100-1000"
                                            <%= query.priceRange === '100-1000' ? 'checked' : '' %>
                                            onchange="this.form.submit()">
                                        ₹100 – ₹1000
                                    </label>
                                    <label>
                                        <input type="radio" name="priceRange" value="1000-2000"
                                            <%= query.priceRange === '1000-2000' ? 'checked' : '' %>
                                            onchange="this.form.submit()">
                                        ₹1000 – ₹2000
                                    </label>
                                    <label>
                                        <input type="radio" name="priceRange" value="2000-5000"
                                            <%= query.priceRange === '2000-5000' ? 'checked' : '' %>
                                            onchange="this.form.submit()">
                                        ₹2000 – ₹5000
                                    </label>
                                    <label>
                                        <input type="radio" name="priceRange" value="5000-10000"
                                            <%= query.priceRange === '5000-10000' ? 'checked' : '' %>
                                            onchange="this.form.submit()">
                                        ₹5000 – ₹10000
                                    </label>
                                    <label>
                                        <input type="radio" name="priceRange" value="10000+"
                                            <%= query.priceRange === '10000+' ? 'checked' : '' %>
                                            onchange="this.form.submit()">
                                        ₹10000+
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Clear Filters -->
                        <div class="filter-actions">
                            <a href="/sale" class="clear-filters-btn">Clear All Filters</a>
                        </div>
                    </aside>

                    <!-- Products Section -->
                    <section class="products" role="main" aria-label="Product listings">
                        <div class="products-header">
                            <h2 class="products-title">
                                All Watches
                                <span class="product-count" id="productCount">
                                    (<%= totalProducts || 0 %>)
                                </span>
                            </h2>
                            <div class="products-controls">
                                <label for="sortSelect" class="sr-only">Sort products by</label>
                                <select class="sort-select" name="sort" id="sortSelect" onchange="this.form.submit()">
                                    <option value="featured" <%= query.sort === 'featured' ? 'selected' : '' %>>Featured</option>
                                    <option value="price-low" <%= query.sort === 'price-low' ? 'selected' : '' %>>Price: Low to High</option>
                                    <option value="price-high" <%= query.sort === 'price-high' ? 'selected' : '' %>>Price: High to Low</option>
                                    <option value="newest" <%= query.sort === 'newest' ? 'selected' : '' %>>Newest</option>
                                </select>
                            </div>
                        </div>

                        <!-- Product Grid -->
                        <div class="product-grid" id="productGrid" role="grid" aria-label="Product grid">
                            <% if (products && products.length > 0) { %>
                                <% products.forEach(function(product) { %>
                                    <% if (product.isListed && product.approvalStatus === 'approved') { %>
                                        <article class="product-card" role="gridcell"
                                            data-category="<%= product.category._id || product.category %>"
                                            data-price="<%= product.discountedPrice || product.price %>"
                                            data-original-price="<%= product.price %>"
                                            data-status="<%= product.productStatus %>"
                                            data-date="<%= product.createdAt %>">

                                            <div class="product-image">
                                                <% 
                                                    let primaryImage = '/images/placeholder-watch.jpg';
                                                    if (product.variants && product.variants[0] && 
                                                        product.variants[0].images && product.variants[0].images.length > 0) {
                                                        primaryImage = product.variants[0].images[0].url;
                                                    }
                                                %>
                                                <img src="<%= primaryImage %>" alt="<%= product.name %> Watch"
                                                    loading="lazy"
                                                    onerror="this.src='/images/placeholder-watch.jpg'"
                                                    class="product-img">

                                                <div class="product-overlay">
                                                    <a href="/product/<%= product._id %>" class="quick-view-btn"
                                                        aria-label="Quick view <%= product.name %>">
                                                        Quick View
                                                    </a>
                                                </div>

                                                <!-- Product Badges -->
                                                <div class="product-badges">
                                                    <% if (product.discountedPrice && product.discountedPrice < product.price && product.price > 0) { %>
                                                        <span class="badge sale-badge">
                                                            <%= Math.round(((product.price - product.discountedPrice) / product.price) * 100) %>% OFF
                                                        </span>
                                                    <% } %>
                                                    <% if (product.totalStock === 0) { %>
                                                        <span class="badge out-of-stock-badge">Out of Stock</span>
                                                    <% } %>
                                                </div>
                                            </div>

                                            <div class="product-info">
                                                <h3 class="product-vendor">
                                                    <%= product.vendorId && product.vendorId.brandName ?
                                                        product.vendorId.brandName : (product.vendorId &&
                                                        product.vendorId.businessName ? product.vendorId.businessName
                                                        : 'Unknown Vendor') %>
                                                </h3>
                                                <h4 class="product-name">
                                                    <%= product.name %>
                                                </h4>
                                                <div class="product-category">
                                                    <span class="category-tag">
                                                        <%= product.category && product.category.name ?
                                                            product.category.name : 'Uncategorized' %>
                                                    </span>
                                                </div>
                                                <div class="product-color">
                                                    <span class="color-tag">
                                                        <%= product.variants && product.variants[0] &&
                                                            product.variants[0].color ? product.variants[0].color
                                                            : 'N/A' %>
                                                    </span>
                                                </div>
                                                <div class="product-price">
                                                    <% if (product.discountedPrice && product.discountedPrice < product.price) { %>
                                                        <span class="original-price">₹<%= product.price.toLocaleString() %></span>
                                                        <span class="current-price">₹<%= product.discountedPrice.toLocaleString() %></span>
                                                    <% } else { %>
                                                        <span class="current-price">₹<%= product.price.toLocaleString() %></span>
                                                    <% } %>
                                                </div>

                                                <button
                                                    class="add-to-cart-btn <%= product.totalStock === 0 ? 'disabled' : '' %>"
                                                    data-product-id="<%= product._id %>"
                                                    data-variant-id="<%= product.variants && product.variants[0] ? product.variants[0]._id : '' %>"
                                                    data-product-name="<%= product.name %>"
                                                    data-product-price="<%= product.discountedPrice || product.price %>"
                                                    <%= product.totalStock === 0 ? 'disabled' : '' %>
                                                    aria-label="<%= product.totalStock === 0 ? 'Out of stock' : 'Add ' + product.name + ' to cart' %>">
                                                    <%= product.totalStock === 0 ? 'Out of Stock' : 'Add to Cart' %>
                                                </button>

                                                <% if (product.totalStock > 0 && product.totalStock <= 5) { %>
                                                    <div class="stock-warning" role="alert">
                                                        Only <%= product.totalStock %> left in stock!
                                                    </div>
                                                <% } %>
                                            </div>
                                        </article>
                                    <% } %>
                                <% }); %>
                            <% } else { %>
                                <div class="no-products" role="status">
                                    <div class="no-products-content">
                                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="1"
                                            aria-hidden="true">
                                            <circle cx="11" cy="11" r="8"></circle>
                                            <path d="m21 21-4.35-4.35"></path>
                                        </svg>
                                        <h3>No products found</h3>
                                        <p>Try adjusting your filters or search terms</p>
                                    </div>
                                </div>
                            <% } %>
                        </div>

                        <!-- Pagination -->
                        <% if (products && products.length > 0 && totalPages > 1) { %>
                            <nav class="pagination" role="navigation" aria-label="Product pagination">
                                <button class="page-btn prev-btn" 
                                    <%= currentPage <= 1 ? 'disabled aria-disabled="true"' : '' %>
                                    data-page="<%= currentPage - 1 %>" aria-label="Previous page">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2" aria-hidden="true">
                                        <polyline points="15,18 9,12 15,6"></polyline>
                                    </svg>
                                    Previous
                                </button>

                                <div class="page-numbers">
                                    <% for (let i = 1; i <= totalPages; i++) { %>
                                        <button class="page-btn <%= i === currentPage ? 'active' : '' %>"
                                            data-page="<%= i %>" aria-label="Page <%= i %>" 
                                            <%= i === currentPage ? 'aria-current="page"' : '' %>>
                                            <%= i %>
                                        </button>
                                    <% } %>
                                </div>

                                <button class="page-btn next-btn" 
                                    <%= currentPage >= totalPages ? 'disabled aria-disabled="true"' : '' %>
                                    data-page="<%= currentPage + 1 %>" aria-label="Next page">
                                    Next
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2" aria-hidden="true">
                                        <polyline points="9,18 15,12 9,6"></polyline>
                                    </svg>
                                </button>
                            </nav>
                        <% } %>
                    </section>
                </div>
            </form>
        </div>
    </div>
</main>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay" aria-hidden="true" role="status">
    <div class="loading-spinner"></div>
</div>

<script>
    (function () {
        'use strict';

        // Mobile filter toggle
        const mobileFilterToggle = document.querySelector('.mobile-filter-toggle');
        const sidebar = document.getElementById('sidebar');
        const closeFilters = document.querySelector('.close-filters');

        function toggleFilters() {
            if (!sidebar) return;
            const isExpanded = mobileFilterToggle.getAttribute('aria-expanded') === 'true';
            mobileFilterToggle.setAttribute('aria-expanded', !isExpanded);
            sidebar.classList.toggle('active');
            document.body.classList.toggle('filters-open');
        }

        if (mobileFilterToggle) {
            mobileFilterToggle.addEventListener('click', toggleFilters);
        }

        if (closeFilters) {
            closeFilters.addEventListener('click', toggleFilters);
        }

        // Close filters when clicking outside
        document.addEventListener('click', function (e) {
            if (!sidebar || !mobileFilterToggle) return;
            if (sidebar.classList.contains('active') &&
                !sidebar.contains(e.target) &&
                !mobileFilterToggle.contains(e.target)) {
                toggleFilters();
            }
        });

        // Pagination handler
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('page-btn') && !e.target.disabled) {
                const page = e.target.dataset.page;
                if (page) {
                    showLoading();
                    const urlParams = new URLSearchParams(window.location.search);
                    urlParams.set('page', page);
                    window.location.href = `/sale?${urlParams.toString()}`;
                }
            }
        });

        // Add to cart handler with axios
        document.addEventListener('click', async function (e) {
            if (e.target.classList.contains('add-to-cart-btn') && !e.target.disabled) {
                const btn = e.target;
                const productId = btn.dataset.productId;
                const variantId = btn.dataset.variantId;
                const productName = btn.dataset.productName;

                const originalText = btn.textContent;
                btn.textContent = "Adding...";
                btn.disabled = true;
                btn.classList.add('loading');

                try {
                    const { data } = await axios.post('/cart/add', {
                        productId,
                        variantId,
                        name: productName,
                    });

                    if (data.success) {
                        btn.textContent = "Added!";
                        btn.classList.add('success');

                        // SweetAlert Success
                        if (typeof Swal !== 'undefined') {
                            Swal.fire({
                                title: "✅ Added to Cart",
                                text: `${productName} has been added to your cart.`,
                                icon: "success",
                                showCancelButton: true,
                                confirmButtonText: "Go to Cart",
                                cancelButtonText: "Continue Shopping",
                                timer: 3000
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    window.location.href = "/cart";
                                }
                            });
                        } else {
                            alert(`${productName} has been added to your cart.`);
                        }

                        // Reset button
                        setTimeout(() => {
                            btn.textContent = originalText;
                            btn.disabled = false;
                            btn.classList.remove('loading', 'success');
                        }, 2000);
                    } else {
                        throw new Error(data.message || 'Failed to add to cart');
                    }
                } catch (error) {
                    console.error("Add to cart failed:", error);
                    btn.textContent = originalText;
                    btn.disabled = false;
                    btn.classList.remove('loading');

                    // Handle auth error
                    if (error.response && error.response.status === 401) {
                        if (typeof Swal !== 'undefined') {
                            Swal.fire({
                                title: "⚠️ Not Logged In",
                                text: "You must log in to add items to your cart.",
                                icon: "warning",
                                confirmButtonText: "Login"
                            }).then(() => window.location.href = "/login");
                        } else {
                            alert("Please log in to add items to your cart.");
                            window.location.href = "/login";
                        }
                        return;
                    }

                    // Other errors
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            title: "Error",
                            text: error.response?.data?.message || error.message || "Something went wrong. Please try again.",
                            icon: "error"
                        });
                    } else {
                        alert(error.response?.data?.message || error.message || "Something went wrong. Please try again.");
                    }
                }
            }
        });

        // Loading overlay functions
        function showLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'flex';
                overlay.setAttribute('aria-hidden', 'false');
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
                overlay.setAttribute('aria-hidden', 'true');
            }
        }

        window.addEventListener('load', hideLoading);
    })();
</script>