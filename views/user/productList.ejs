<link rel="stylesheet" href="/styles/user/productList.css">

<!-- Hero Banner -->
<section class="hero">
    <div class="container">
        <div class="hero-content">
            <div class="hero-text">
                <h2 class="hero-title">Premium Watch Collection</h2>
                <p class="hero-subtitle">Discover timeless elegance with our curated selection</p>
                <a href="/watches" class="hero-btn">Shop Now</a>
            </div>
            <div class="hero-image">
                <img src="/images/hero-watch.jpg" alt="Premium Watch Collection" class="hero-watch" />
            </div>
        </div>
    </div>
</section>

<!-- Main Content -->
<main class="main">
    <div class="container">
        <div class="content-wrapper">
            <form action="/sale" method="GET" id="filterForm">
                <div class="search-section">
                    <input type="text" name="search" placeholder="Search watches (e.g., Veltron)"
                           value="<%= query.search || '' %>" aria-label="Search watches">
                    <button type="submit">Search</button>
                </div>

                <div class="filter-products-wrapper">
                    <aside class="sidebar">
                    <div class="filter-section">
                        <h3 class="filter-title">Categories</h3>
                        <ul class="filter-list">
                            <% if (categories && categories.length > 0) { %>
                                <% categories.forEach(function(cat) { %>
                                    <li>
                                        <label>
                                            <input type="checkbox" name="category" value="<%= cat._id %>" 
                                                   <%= query.category && Array.isArray(query.category) && query.category.includes(cat._id.toString()) ? 'checked' : '' %> 
                                                   onchange="this.form.submit()">
                                            <%= cat.name || 'Uncategorized' %>
                                        </label>
                                    </li>
                                <% }); %>
                            <% } else { %>
                                <li>No categories available</li>
                            <% } %>
                        </ul>
                    </div>

                    <div class="filter-section">
                        <h3 class="filter-title">Strap Style</h3>
                        <ul class="filter-list">
                            <% if (strapStyles && strapStyles.length > 0) { %>
                                <% strapStyles.forEach(function(style) { %>
                                    <li>
                                        <label>
                                            <input type="checkbox" name="strapStyle" value="<%= style %>" 
                                                   <%= query.strapStyle && Array.isArray(query.strapStyle) && query.strapStyle.includes(style) ? 'checked' : '' %> 
                                                   onchange="this.form.submit()">
                                            <%= style %>
                                        </label>
                                    </li>
                                <% }); %>
                            <% } else { %>
                                <li>No strap styles available</li>
                            <% } %>
                        </ul>
                    </div>

                    <div class="filter-section">
                        <h3 class="filter-title">Price Range</h3>
                        <div class="price-range">
                            <input type="range" min="0" max="10000" 
                                   id="priceRange"
                                   value="<%= query.maxPrice || 10000 %>" 
                                   class="price-slider" name="maxPrice" 
                                   aria-label="Maximum price filter"
                                   oninput="document.getElementById('maxPrice').textContent = `₹${this.value === '10000' ? '10000+' : this.value}`; this.form.submit()">
                            <div class="price-labels">
                                <span id="minPrice">₹0</span>
                                <span id="maxPrice">₹<%= query.maxPrice || '10000+' %></span>
                            </div>
                        </div>
                    </div>
                </aside>

                <section class="products">
                    <div class="products-header">
                        <h2 class="products-title">All Watches (<span id="productCount"><%= totalProducts || 0 %></span>)</h2>
                        <div class="products-controls">
                            <select class="sort-select" name="sort" onchange="this.form.submit()">
                                <option value="featured" <%= query.sort === 'featured' ? 'selected' : '' %>>Featured</option>
                                <option value="price-low" <%= query.sort === 'price-low' ? 'selected' : '' %>>Price: Low to High</option>
                                <option value="price-high" <%= query.sort === 'price-high' ? 'selected' : '' %>>Price: High to Low</option>
                                <option value="newest" <%= query.sort === 'newest' ? 'selected' : '' %>>Newest</option>
                            </select>
                        </div>
                    </div>

                    <div class="product-grid" id="productGrid">
                        <% if (products && products.length > 0) { %>
                            <% products.forEach(function(product) { %>
                                <% if (product.isListed && product.approvalStatus === 'approved') { %>
                                    <div class="product-card" 
                                         data-category="<%= product.category._id || product.category %>"
                                         data-price="<%= product.discountedPrice || product.price %>"
                                         data-original-price="<%= product.price %>"
                                         data-status="<%= product.productStatus %>"
                                         data-date="<%= product.createdAt %>">
                                        <div class="product-image">
                                            <% 
                                                let primaryImage = '/images/placeholder-watch.jpg';
                                                if (product.variants && product.variants.length > 0 && 
                                                    product.variants[0].images && product.variants[0].images.length > 0) {
                                                    primaryImage = product.variants[0].images[0].url;
                                                }
                                            %>
                                            <img src="<%= primaryImage %>" 
                                                 alt="<%= product.name %> Watch" 
                                                 loading="lazy" 
                                                 onerror="this.src='/images/placeholder-watch.jpg'" />
                                            <div class="product-overlay">
                                                <a href="/sale/<%= product._id %>" class="quick-view-btn">Quick View</a>
                                            </div>
                                            <% if (product.createdAt && new Date(product.createdAt) > new Date(Date.now() - 30*24*60*60*1000)) { %>
                                                <span class="badge new-badge">New</span>
                                            <% } %>
                                            <% if (product.discountedPrice && product.discountedPrice < product.price) { %>
                                                <span class="badge sale-badge">
                                                    <%= Math.round(((product.price - product.discountedPrice) / product.price) * 100) %>% OFF
                                                </span>
                                            <% } %>
                                            <% if (product.isOutOfStock) { %>
                                                <span class="badge out-of-stock-badge">Out of Stock</span>
                                            <% } %>
                                        </div>
                                        <div class="product-info">
                                            <h3 class="product-vendor">
                                                <%= product.vendorId && product.vendorId.brandName ? product.vendorId.brandName : 
                                                    (product.vendorId && product.vendorId.businessName ? product.vendorId.businessName : 'Unknown Vendor') %>
                                            </h3>
                                            <h4 class="product-name"><%= product.name %></h4>
                                            <div class="product-category">
                                                <span class="category-tag">
                                                    <%= product.category && product.category.name ? product.category.name : 'Uncategorized' %>
                                                </span>
                                            </div>
                                            <div class="product-price">
                                                <% if (product.discountedPrice && product.discountedPrice < product.price) { %>
                                                    <span class="original-price">₹<%= product.price.toLocaleString() %></span>
                                                    <span class="current-price">₹<%= product.discountedPrice.toLocaleString() %></span>
                                                <% } else { %>
                                                    <span class="current-price">₹<%= product.price.toLocaleString() %></span>
                                                <% } %>
                                            </div>
                                            <button class="add-to-cart-btn <%= product.isOutOfStock ? 'disabled' : '' %>" 
                                                    data-product-id="<%= product._id %>"
                                                    data-product-name="<%= product.name %>"
                                                    data-product-price="<%= product.discountedPrice || product.price %>"
                                                    <%= product.isOutOfStock ? 'disabled' : '' %>
                                                    aria-label="<%= product.isOutOfStock ? 'Out of stock' : 'Add ' + product.name + ' to cart' %>">
                                                <%= product.isOutOfStock ? 'Out of Stock' : 'Add to Cart' %>
                                            </button>
                                            <% if (!product.isOutOfStock && product.totalStock > 0 && product.totalStock <= 5) { %>
                                                <div class="stock-warning">Only <%= product.totalStock %> left in stock!</div>
                                            <% } %>
                                        </div>
                                    </div>
                                <% } %>
                            <% }); %>
                        <% } else { %>
                            <div class="no-products">
                                <p>No products found. Try different filters.</p>
                            </div>
                        <% } %>
                    </div>

                    <% if (products && products.length > 0) { %>
                        <div class="pagination">
                            <button class="page-btn prev-btn" 
                                    <% if (currentPage <= 1) { %>disabled aria-disabled="true"<% } %> 
                                    data-page="<%= currentPage - 1 %>"
                                    aria-label="Previous page">
                                Previous
                            </button>
                            <% for(let i = 1; i <= totalPages; i++) { %>
                                <button class="page-btn <%= i === currentPage ? 'active' : '' %>" 
                                        data-page="<%= i %>"
                                        aria-label="Page <%= i %>">
                                    <%= i %>
                                </button>
                            <% } %>
                            <button class="page-btn next-btn" 
                                    <% if (currentPage >= totalPages) { %>disabled aria-disabled="true"<% } %>
                                    data-page="<%= currentPage + 1 %>"
                                    aria-label="Next page">
                                Next
                            </button>
                        </div>
                    <% } %>
                </section>
                </div>
            </form>
        </div>
    </div>
</main>

<script>
    document.getElementById('priceRange')?.addEventListener('input', function() {
        document.getElementById('maxPrice').textContent = `₹${this.value === '10000' ? '10000+' : this.value}`;
    });

    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('page-btn') && !e.target.disabled) {
            const page = e.target.dataset.page;
            if (page) {
                const urlParams = new URLSearchParams(window.location.search);
                urlParams.set('page', page);
                window.location.href = `/sale?${urlParams.toString()}`;
            }
        }
    });
</script>
